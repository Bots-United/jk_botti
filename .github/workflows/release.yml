name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate-tag:
    runs-on: ubuntu-latest
    outputs:
      ver_major: ${{ steps.parse.outputs.VER_MAJOR }}
      ver_minor: ${{ steps.parse.outputs.VER_MINOR }}
      ver_note: ${{ steps.parse.outputs.VER_NOTE }}
    steps:
      - name: Parse version from tag
        id: parse
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" =~ ^v([0-9]+)\.([0-9]+)(.*)$ ]]; then
            echo "VER_MAJOR=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
            echo "VER_MINOR=${BASH_REMATCH[2]}" >> "$GITHUB_OUTPUT"
            echo "VER_NOTE=${BASH_REMATCH[3]}" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Invalid tag format '$TAG', expected v<int>.<int><string>"
            exit 1
          fi

  build-linux:
    needs: validate-tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Update package list for i386
        run: sudo dpkg --add-architecture i386 && sudo apt-get -y update
      - name: Install packages
        run: sudo apt-get -y install build-essential g++-multilib
      - name: Build
        run: CC="gcc -m32" CXX="g++ -m32" AR="ar rc" RANLIB="ranlib" make -j4 VER_MAJOR=${{ needs.validate-tag.outputs.ver_major }} VER_MINOR=${{ needs.validate-tag.outputs.ver_minor }} VER_NOTE=${{ needs.validate-tag.outputs.ver_note }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: jk_botti_mm_i386.so

  build-windows:
    needs: validate-tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install packages
        run: sudo apt-get -y update && sudo apt-get -y install gcc-mingw-w64 g++-mingw-w64
      - name: Build
        run: make -j4 OSTYPE=win32 VER_MAJOR=${{ needs.validate-tag.outputs.ver_major }} VER_MINOR=${{ needs.validate-tag.outputs.ver_minor }} VER_NOTE=${{ needs.validate-tag.outputs.ver_note }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: jk_botti_mm.dll

  release:
    needs: [validate-tag, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: addons/jk_botti/dlls
      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: addons/jk_botti/dlls
      - name: Prepare release directory
        run: |
          rm -f addons/jk_botti/dlls/.empty_dir
          ln -sf jk_botti_mm_i386.so addons/jk_botti/dlls/jk_botti_mm.so
      - name: Create release archive
        run: tar c addons | xz > jk_botti-${{ steps.get_version.outputs.VERSION }}-release.tar.xz
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: jk_botti-${{ steps.get_version.outputs.VERSION }}-release.tar.xz
